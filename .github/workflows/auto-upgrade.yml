name: Build Nextcloud from upstream daily and push to AUR latest release

on:
  push:
    branches: ["main"]
  pull_request: 
    branches: ["main"]

  workflow_dispatch:

jobs:
  Update-AppImage:
    runs-on: ubuntu-latest
    environment: CI_PROD
    container: archlinux:latest
    steps:
      - name: Checkout codebase
        uses: actions/checkout@v4
          # TODO: Build automatically inside an ArchLinux Chroot
          # Use ssh-agent for private key
      - name: Pacman key init, upgrade, update, install deps
        run: pacman-key --init && pacman -Syu --noconfirm 

      - name: Install all latest dependencies in container
        run: |
          pacman -S --noconfirm zlib curl p7zip wget bash base-devel git pacman-contrib ssh-agent
      - name: Restart gpg-server as it may be old
        run : gpgconf --kill all
      - uses: webfactory/ssh-agent@v0.9.0
        with:
            ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Create a user for makepkg usage
        run: |
          chmod a+rwx ./update.sh
          chmod a+rwx -R .
          useradd makepkg-user
      - name: Git clone from AUR
        run: git clone https://aur.archlinux.org/nextcloud-client-appimage-daily.git
      # INSERT step to setup git config from ENV variable containing secrets????
      # TODO: Find if that's a good solution ^ or to avoid in terms of security
      # Read a lot of documentation and blogs...
      # TODO: Forced to use chroot because we are the root user in the container
      - name: Build latest update from upstream
        run: |
          chmod +x ./update.sh
          su makepkg-user -c "bash ./update.sh"
          # Move into AUR git repo
          cd nextcloud-client-appimage-daily
          # Push to AUR the update
          git fetch origin
          git checkout origin
          git add -A . && git commit -m "Update to latest version" #&& git push origin upstream
          git status
          git diff
